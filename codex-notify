#!/usr/bin/env bash
set -euo pipefail

payload="${1:-}"
title="Codex"
msg="Task finished"
subtitle=""
group=""
sound="/System/Library/Sounds/Glass.aiff"
activate_bundle="${CODEX_ACTIVATE_BUNDLE:-com.microsoft.VSCode}"
sender_bundle="${CODEX_SENDER_BUNDLE:-com.microsoft.VSCode}"
suppress_frontmost="${CODEX_SUPPRESS_FRONTMOST:-1}"
exec_only="${CODEX_NOTIFY_EXEC_ONLY:-1}"
app_icon="${CODEX_NOTIFY_APP_ICON:-}"

if [[ -z "$app_icon" && "$activate_bundle" == "com.microsoft.VSCode" ]]; then
  default_icon="/Applications/Visual Studio Code.app/Contents/Resources/Code.icns"
  if [[ -f "$default_icon" ]]; then
    app_icon="$default_icon"
  fi
fi

if [[ -n "$app_icon" && "$app_icon" != http* && "$app_icon" != file://* ]]; then
  if [[ -f "$app_icon" ]]; then
    if command -v python3 >/dev/null 2>&1; then
      app_icon="$(python3 - "$app_icon" <<'PY'
from pathlib import Path
import sys

print(Path(sys.argv[1]).resolve().as_uri())
PY
)"
    else
      app_icon="file://$app_icon"
    fi
  fi
fi

# Optional quiet mode: set CODEX_SILENT=1 to disable sound
if [[ "${CODEX_SILENT:-}" == "1" ]]; then
  sound=""
fi

if [[ "$suppress_frontmost" != "0" && -n "$activate_bundle" ]] && command -v osascript >/dev/null 2>&1; then
  front_bundle="$(osascript -e 'tell application "System Events" to get bundle identifier of first application process whose frontmost is true' 2>/dev/null || true)"
  if [[ -n "$front_bundle" && "$front_bundle" == "$activate_bundle" ]]; then
    exit 0
  fi
fi

if [[ -n "$payload" && "$payload" == "{"* ]] && command -v python3 >/dev/null 2>&1; then
  parsed=()
  while IFS= read -r line; do
    parsed+=("$line")
  done < <(python3 - "$payload" <<'PY'
import json, sys
import os

def clean(val: object) -> str:
    s = "" if val is None else str(val)
    return " ".join(s.split())

def clip(s: str, limit: int) -> str:
    s = clean(s)
    return s if len(s) <= limit else s[: max(0, limit - 3) ] + "..."

try:
    payload = json.loads(sys.argv[1])
except Exception:
    sys.exit(1)

event_type = clean(payload.get("type", ""))
allow_env = os.environ.get("CODEX_NOTIFY_EVENT_TYPES", "agent-turn-complete")
allowed = [s.strip() for s in allow_env.split(",") if s.strip()]
if not allowed:
    allowed = ["agent-turn-complete"]
if allowed != ["*"] and event_type and event_type not in allowed:
    sys.exit(0)

last = clean(payload.get("last-assistant-message", "")) or "Turn complete"
title = f"Codex: {clip(last, 90)}"

inputs = payload.get("input-messages", [])
if isinstance(inputs, list):
    parts = []
    for item in inputs:
        if isinstance(item, str):
            parts.append(item)
        else:
            parts.append(json.dumps(item, ensure_ascii=True))
    inputs_text = " / ".join(parts)
else:
    inputs_text = str(inputs)

message = clip(inputs_text, 140) or "Turn complete"
cwd = clip(payload.get("cwd", ""), 140)
thread_id = clean(payload.get("thread-id", ""))
group = f"codex-{thread_id}" if thread_id else ""

print(title)
print(message)
print(cwd)
print(group)
PY
  )
  if [[ ${#parsed[@]} -eq 0 ]]; then
    exit 0
  fi
  title="${parsed[0]:-Codex}"
  msg="${parsed[1]:-Task finished}"
  subtitle="${parsed[2]:-}"
  group="${parsed[3]:-}"
else
  if [[ -z "$payload" || "$payload" != "{"* ]]; then
    title="${1:-$title}"
    msg="${2:-$msg}"
    if [[ -n "${3:-}" ]]; then
      sound="${3}"
    fi
  fi
fi

tn_bin="$(command -v terminal-notifier 2>/dev/null || true)"
if [[ -z "$tn_bin" ]]; then
  for candidate in /opt/homebrew/bin/terminal-notifier /usr/local/bin/terminal-notifier; do
    if [[ -x "$candidate" ]]; then
      tn_bin="$candidate"
      break
    fi
  done
fi

if [[ -n "$tn_bin" ]]; then
  tn_args=(-title "$title" -message "$msg")
  if [[ -n "$subtitle" ]]; then
    tn_args+=(-subtitle "$subtitle")
  fi
  if [[ -n "$group" ]]; then
    tn_args+=(-group "$group")
  fi
  if [[ -n "$app_icon" ]]; then
    tn_args+=(-appIcon "$app_icon")
  fi
  if [[ -n "$activate_bundle" ]]; then
    if [[ "$exec_only" != "0" ]]; then
      tn_args+=(-execute "osascript -e 'tell application id \"${activate_bundle}\" to activate'")
    else
      tn_args+=(-activate "$activate_bundle")
    fi
  fi
  if [[ "$exec_only" == "0" && -n "$sender_bundle" ]]; then
    tn_args+=(-sender "$sender_bundle")
  fi
  "$tn_bin" "${tn_args[@]}" || echo "$title: $msg" >&2
else
  if [[ -n "$subtitle" ]]; then
    msg="$msg - $subtitle"
  fi
  osascript -e "display notification \"$msg\" with title \"$title\"" \
    || echo "$title: $msg" >&2
fi

if [[ -n "$sound" ]]; then
  afplay "$sound" >/dev/null 2>&1 || true
fi
